// Generated by CoffeeScript 1.3.3
(function() {
  var appId, fillTable, getEighteenYears, getSex, query, queryFacebook, server;

  appId = "188082917990051";

  server = "//matcher.azurewebsites.net";

  (function(d) {
    var id, js, ref;
    id = "facebook-jssdk";
    ref = d.getElementsByTagName("script")[0];
    if (d.getElementById(id)) {
      return;
    }
    js = d.createElement("script");
    js.id = id;
    js.async = true;
    js.src = "//connect.facebook.net/en_US/all.js";
    return ref.parentNode.insertBefore(js, ref);
  })(document);

  window.fbAsyncInit = function() {
    var loggedIn;
    FB.init({
      appId: "" + appId,
      channelUrl: "" + server + "/channel.html",
      status: true,
      cookie: true,
      xfbml: true
    });
    loggedIn = function(response) {
      if (response.authResponse) {
        return FB.api("/me", function(me) {
          window.token = response.authResponse.accessToken;
          window.uid = me.id;
          window.sex = me.sex;
          return queryFacebook();
        });
      }
    };
    return FB.Event.subscribe("auth.statusChange", loggedIn);
  };

  $(function() {
    $("#btnSearch").click(function() {
      return queryFacebook();
    });
    return $('.nav-tabs').button();
  });

  getSex = function() {
    var selected;
    selected = $("#gender .active");
    return selected.html().toLowerCase();
  };

  getEighteenYears = function() {
    var date, eighteenYears, month, twoDigitMonth;
    date = new Date;
    date.setFullYear(date.getFullYear() - 18);
    month = date.getMonth() + 1;
    twoDigitMonth = month >= 10 ? "" + month : "0" + month;
    eighteenYears = twoDigitMonth + "/" + date.getDate() + "/" + date.getFullYear();
    return eighteenYears;
  };

  query = function() {
    return "SELECT uid, name, last_name, mutual_friend_count,\n       interests, relationship_status, profile_url,\n       birthday_date, pic FROM user\nWHERE\n  uid = me()\n  or\n  (\n    birthday_date > '" + (getEighteenYears()) + "'\n    AND\n    sex = '" + (getSex()) + "'\n    AND\n    uid IN (SELECT uid2 FROM friend WHERE uid1 = me())\n  )\nLIMIT 100";
  };

  queryFacebook = function() {
    var uri,
      _this = this;
    if (window.token && window.uid) {
      uri = encodeURI("https://graph.facebook.com/fql?q=" + (query()) + "&access_token=" + window.token);
      return $.getJSON(uri, function(results) {
        return $.post("" + server + "/user/" + window.uid, results, fillTable);
      });
    }
  };

  fillTable = function(users) {
    var user, _i, _len, _results;
    $('#results').empty();
    _results = [];
    for (_i = 0, _len = users.length; _i < _len; _i++) {
      user = users[_i];
      _results.push($("#results").append("<tr>\n  <td>" + user.name + "</td>\n  <td>" + (user.percent.toFixed(2)) + "%</td>\n  <td>" + (user.relationship_status !== 'null' ? user.relationship_status : "N/A") + "</td>\n  <td><a href='" + user.profile_url + "'><img src=" + user.pic + "/j></a></td>\n</tr>\""));
    }
    return _results;
  };

}).call(this);
