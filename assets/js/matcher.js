// Generated by IcedCoffeeScript 1.4.0a
(function() {
  var appId, getSex, iced, query, queryFacebook, server, __iced_k, __iced_k_noop;

  iced = require('iced-coffee-script').iced;
  __iced_k = __iced_k_noop = function() {};

  appId = "188082917990051";

  server = "//matcher.azurewebsites.net";

  (function(d) {
    var id, js, ref;
    id = "facebook-jssdk";
    ref = d.getElementsByTagName("script")[0];
    if (d.getElementById(id)) return;
    js = d.createElement("script");
    js.id = id;
    js.async = true;
    js.src = "//connect.facebook.net/en_US/all.js";
    return ref.parentNode.insertBefore(js, ref);
  })(document);

  window.fbAsyncInit = function() {
    FB.init({
      appId: "" + appId,
      channelUrl: "" + server + "/channel.html",
      status: true,
      cookie: true,
      xfbml: true
    });
    loggedIn(function(response) {
      var me, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      if (response.authResponse) {
        (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            parent: ___iced_passed_deferral,
            filename: "matcher.coffee"
          });
          FB.api("/me", __iced_deferrals.defer({
            assign_fn: (function() {
              return function() {
                return me = arguments[0];
              };
            })(),
            lineno: 29
          }));
          __iced_deferrals._fulfill();
        })(function() {
          window.token = response.authResponse.accessToken;
          window.uid = me.id;
          window.sex = me.sex;
          return __iced_k(queryFacebook());
        });
      } else {
        return __iced_k();
      }
    });
    return FB.Event.subscribe("auth.statusChange", loggedIn);
  };

  query = "SELECT uid, name, last_name, mutual_friend_count, interests,\n  relationship_status, profile_url, pic, birthday_date FROM user\nWHERE\n  uid = me()\n  or\n  (\n    sex = '" + (getSex()) + "'\n    AND\n    uid IN (SELECT uid2 FROM friend WHERE uid1 = me())\n  )\nLIMIT 100";

  $(function() {
    $("#btnSearch").click(function() {
      return queryFacebook();
    });
    return $('.nav-tabs').button();
  });

  getSex = function() {
    return $("#gender .active").html().toLowerCase();
  };

  queryFacebook = function() {
    var results, uri, user, users, ___iced_passed_deferral, __iced_deferrals, __iced_k,
      _this = this;
    __iced_k = __iced_k_noop;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    if (window.token && window.uid) {
      uri = encodeURI("https://graph.facebook.com/fql?q=" + (query()) + "&access_token=" + window.token);
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "matcher.coffee",
          funcname: "queryFacebook"
        });
        $.getJSON(uri, __iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              return results = arguments[0];
            };
          })(),
          lineno: 64
        }));
        __iced_deferrals._fulfill();
      })(function() {
        (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            parent: ___iced_passed_deferral,
            filename: "matcher.coffee",
            funcname: "queryFacebook"
          });
          $.post("" + server + "/user/" + window.uid, results, __iced_deferrals.defer({
            assign_fn: (function() {
              return function() {
                return users = arguments[0];
              };
            })(),
            lineno: 66
          }));
          __iced_deferrals._fulfill();
        })(function() {
          var _i, _len;
          $('#results').empty();
          for (_i = 0, _len = users.length; _i < _len; _i++) {
            user = users[_i];
            $("#results").append("<tr>\n  <td>" + user.name + "</td>\n  <td>" + (user.percent.toFixed(2)) + "%</td>\n  <td>" + (user.relationship_status !== 'null' ? user.relationship_status : "N/A") + "</td>\n  <td><a href='" + user.profile_url + "'><img src=" + user.pic + "></a></td>\n</tr>\"");
          }
          return __iced_k();
        });
      });
    } else {
      return __iced_k();
    }
  };

}).call(this);
